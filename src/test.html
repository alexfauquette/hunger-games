<!doctype html>
<html>
  <head>
    <script type="module">
// WICG Shape Detection API
// - https://wicg.github.io/shape-detection-api/
try {
  const start = document.getElementById("start");
  const video = document.getElementById("video");
  const result = document.getElementById("result");
  const interm = document.getElementById("interm");
  const error = document.getElementById("error");
  const canvas1 = document.getElementById("canvas1");
  
  const bd = new BarcodeDetector();
  (async () => {
    // It works on chrome on Android (chrome://flags Experimental Web Platform features)
    //NOTE: Not implemented yet: chrome canary 84 on macos
    result.textContent = (await BarcodeDetector.getSupportedFormats()).join("\n");
  })().catch(err => {
    result.textContent = err;
  });

  function reshape(video) {
        var w = video.videoWidth;
        var h = video.videoHeight;

        
        interm.textContent = JSON.stringify({
            video: {
                x:0, y:(h-h%2)/2, w, h:(w-w%10)/10, 
            },
            canvas:{
               x: 0, y:0, w:500, h:50
            }
        }, null, 2)        
        var ctx = canvas1.getContext('2d');
        ctx.drawImage(video, 0, (h-h%2)/2, w, (w-w%10)/10, 0, 0, 500, 50);
        return canvas1;
    }
  const capture = async () => {
    try {
      const barcodes = await bd.detect(reshape(video));
      const log = barcodes.map(({format, rawValue}) => `- ${format}: ${rawValue}`).join("\n");
      result.textContent = log;
      requestAnimationFrame(capture);
    } catch (err) {
        error.textContent=err
      console.error(err);
    }
  };
  
  video.addEventListener("play", () => capture());
  
  start.addEventListener("click", () => {
    start.disabled = true;
    (async () => {
      const media = await navigator.mediaDevices.getUserMedia(
        {auido: false, video: {
          //NOTE: crash on android  chrome when specified the size
          //width: {ideal: 800}, height: {ideal: 800},
          facingMode: "environment"}});
      //console.log(media);
      video.srcObject = media;
      video.autoplay = true;
    })().catch(console.error);
  }, {once: true});

} catch (err) {
  document.getElementById("result").textContent = err;
}
    </script>
  </head>
  <body>
    BarcodeDetector demo: <button id="start">start</button>
    <div><video id="video" autoplay></div>
    <pre id="result"></pre>
    <pre id="interm"></pre>
    <pre id="error"></pre>
    <canvas id="canvas1" width="500" height="50" style="background-color: red;"></canvas>
  </body>
</html>