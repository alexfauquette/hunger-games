<!doctype html>
<html>
  <head>
    <script type="module">
      // WICG Shape Detection API
      // - https://wicg.github.io/shape-detection-api/
      try {
        const start = document.getElementById("start");
        const video = document.getElementById("video");

        const bd = new BarcodeDetector();

        const seen = {}(async () => {
          // It works on chrome on Android (chrome://flags Experimental Web Platform features)
          //NOTE: Not implemented yet: chrome canary 84 on macos
          result.textContent = (
            await BarcodeDetector.getSupportedFormats()
          ).join("\n");
        })().catch((err) => {
          result.textContent = err;
        });

        let lastValue = "";
        let valueCount = 0;

        const capture = async () => {
          try {
            const barcodes = await bd.detect(video);
            const value = barcodes.find(({ format }) => format === "ean_13");

            if (value !== null) {
              if (lastValue === value) {
                valueCount += 1;
              } else {
                lastValue = value;
                valueCount = 1;
              }
            }
            result.textContent = `${lastValue} (${valueCount})`;

            if (valueCount === 3 && !seen[value]) {
              const w = video.videoWidth;
              const h = video.videoHeight;
              const imgCanvas = document.createElement("canvas");
              const imgContext = imgCanvas.getContext("2d");

              // canvas size = image size
              imgCanvas.width = w;
              imgCanvas.height = h;

              // draw image
              imgContext.drawImage(video, 0, 0, w, h);

              // image to base64
              imageSrc = imgCanvas.toDataURL("image/png");

              // localStorage.setItem(code, imageSrc);

              const img = document.createElement("img");
              img.src = imageSrc;

              const container = document.getElementById("seen");
              container.appendChild(img);
            }

            requestAnimationFrame(capture);
          } catch (err) {
            error.textContent = err;
            console.error(err);
          }
        };

        video.addEventListener("play", () => capture());

        start.addEventListener(
          "click",
          () => {
            start.disabled = true;
            (async () => {
              const media = await navigator.mediaDevices.getUserMedia({
                auido: false,
                video: {
                  //NOTE: crash on android  chrome when specified the size
                  //width: {ideal: 800}, height: {ideal: 800},
                  facingMode: "environment",
                },
              });
              video.srcObject = media;
              video.autoplay = true;
            })().catch(console.error);
          },
          { once: true },
        );
      } catch (err) {
        document.getElementById("result").textContent = err;
      }
    </script>
  </head>
  <body>
    BarcodeDetector demo: <button id="start">start</button>
    <div><video id="video" autoplay></video></div>

    <pre id="result"></pre>
    <pre id="interm"></pre>
    <pre id="error"></pre>
    <pre id="result2"></pre>

    <div id="seen"></div>
  </body>
</html>
